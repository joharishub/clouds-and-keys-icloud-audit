<!-- 
Clouds & Keys — Guided iCloud Security Audit (Guided Audit v1)
Merged: v14.6 audit logic + Guide v1 detailed text + images between details and Steps
© 2025 Clouds & Keys. All rights reserved. Self-contained, no external deps.
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guided iCloud Security Audit — Clouds & Keys</title>
<style>
    /* ================== SCOPE ================== */
    #ck-wizard { font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Text", Inter, Arial, Helvetica, sans-serif; color:#111827; }
    #ck-wizard * { box-sizing:border-box; }
    #ck-wizard .wrap { max-width:860px; margin:24px auto; padding:16px; }
    #ck-wizard .card { background:#fff; border:1px solid #E5E7EB; border-radius:16px; padding:20px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    #ck-wizard h1 { font-size:22px; margin:0 0 8px; color:#0F172A; }
    #ck-wizard h3 { font-size:18px; margin:0 0 6px; color:#111827; }
    #ck-wizard p { margin:0 0 12px; line-height:1.5; }
    #ck-wizard .muted { color:#6B7280; }
    
    /* Brand */
    :root{
        --ck-blue:#2563EB;
        --ck-blue2:#3882F6;
        --ck-green:#16A34A;
        --ck-amber:#D97706;
        --ck-red:#DC2626;
        --ck-gray:#6B7280;
        --ck-slate:#374151;
        --ck-bg:#F8FAFC;
    }
    
    /* Pills / buttons */
    #ck-wizard .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid transparent; border-radius:999px; padding:10px 14px; font-size:14px; font-weight:600; background:#fff; cursor:pointer; transition:all .2s ease; }
    #ck-wizard .btn-primary { background:var(--ck-blue); color:#fff; }
    #ck-wizard .btn-secondary { color:var(--ck-blue); border-color:var(--ck-blue); }
    #ck-wizard .btn-ghost { color:#111827; border-color:#E5E7EB; }
    #ck-wizard .btn:disabled { opacity:.55; cursor:not-allowed; }
    
    /* Badges */
    #ck-wizard .badge { display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px; font-weight:700; border:1px solid transparent; }
    #ck-wizard .badge.neutral { background:#F3F4F6; color:#374151; border-color:#E5E7EB; }
    #ck-wizard .badge.minimal { background:#ECFDF5; color:var(--ck-green); border-color:#BBF7D0; }
    #ck-wizard .badge.low { background:#FFFBEB; color:var(--ck-amber); border-color:#FDE68A; }
    #ck-wizard .badge.high { background:#FEF2F2; color:var(--ck-red); border-color:#FECACA; }
    
    /* Progress bar */
    #ck-wizard .progress { height:8px; width:100%; background:#E5E7EB; border-radius:999px; overflow:hidden; }
    #ck-wizard .progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--ck-blue),var(--ck-blue2)); transition:width .25s ease; }
    #ck-wizard .notes { font-size:13px; color:#6B7280; margin-top:6px; }
    
    /* Topbar */
    #ck-wizard .topbar { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    #ck-wizard .legend { font-size:13px; color:#6B7280; display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 0; }
    #ck-wizard .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    #ck-wizard .dot.green{ background:var(--ck-green); }
    #ck-wizard .dot.amber{ background:var(--ck-amber); }
    #ck-wizard .dot.gray{ background:#9CA3AF; }
    
    /* Details (replaces "Why it matters" box) */
    #ck-wizard .detail { margin:10px 0 12px; color:#111827; }
    
    /* Steps (blue) */
    #ck-wizard .action { background:#F9FAFB; border:1px solid #E5E7EB; border-radius:12px; padding:12px; margin:12px 0; }
    #ck-wizard .action strong { display:block; margin-bottom:6px; }
    #ck-wizard .action p { margin:0; color:var(--ck-blue); font-weight:600; }
    
    /* Step image */
    #ck-wizard .step-img {
      display:block;
      max-height:320px;
      max-width:100%;
      margin:10px auto 12px;
      object-fit:contain;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.10);
    }
    
    /* Footer area */
    #ck-wizard .foot { display:flex; justify-content:space-between; align-items:center; margin-top:16px; }
    #ck-wizard .hidden { display:none !important; }
    
    /* Drawer (slide-out) */
    #ck-wizard .drawer-mask { position:fixed; inset:0; background:rgba(17,24,39,.35); backdrop-filter:blur(1px); opacity:0; pointer-events:none; transition:opacity .2s ease; }
    #ck-wizard .drawer-mask.open { opacity:1; pointer-events:auto; }
    #ck-wizard .drawer { position:fixed; top:0; right:-364px; width:340px; max-width:86vw; height:100%; background:#fff; border-left:1px solid #E5E7EB; box-shadow:-8px 0 24px rgba(0,0,0,.08); transition:right .25s ease; display:flex; flex-direction:column; }
    #ck-wizard .drawer.open { right:0; }
    #ck-wizard .drawer-head { padding:14px 16px; border-bottom:1px solid #E5E7EB; display:flex; align-items:center; justify-content:space-between; }
    #ck-wizard .drawer-title { font-weight:800; color:#111827; }
    #ck-wizard .drawer-body { padding:10px 0 14px; overflow:auto; }
    #ck-wizard .drawer-section { padding:10px 16px; }
    #ck-wizard .mini { font-size:13px; color:#6B7280; }
    #ck-wizard .row { display:flex; align-items:center; gap:10px; padding:10px 16px; border-bottom:1px solid #F3F4F6; cursor:pointer; }
    #ck-wizard .row:hover { background:#F9FAFB; }
    #ck-wizard .status { width:10px; height:10px; border-radius:50%; border:1px solid #E5E7EB; }
    #ck-wizard .status.enabled { background:var(--ck-green); border-color:var(--ck-green); }
    #ck-wizard .status.reviewed { background:var(--ck-amber); border-color:var(--ck-amber); }
    #ck-wizard .status.skipped { background:#9CA3AF; border-color:#9CA3AF; }
    #ck-wizard .row-title { font-size:14px; color:#111827; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    
    @media(max-width:520px){ #ck-wizard .btn{padding:8px 12px;} }
    #ck-wizard #stepImage {
      display:block !important;
      opacity:1 !important;
      width:100% !important;
      max-width:460px !important;
      min-height:120px !important;
      margin:14px auto !important;
      object-fit:contain !important;
      border-radius:12px !important;
      background:#fff !important;
      box-shadow:0 1px 4px rgba(0,0,0,.08) !important;
    }
    #ck-wizard #stepImage {
      display:block !important;
      visibility:visible !important;
    }
</style>
</head>
<body>
<div id="ck-wizard">
  <div class="wrap">
    <!-- LANDING -->
    <div id="landing" class="card" style="text-align:center;">
      <h1>Guided iCloud Security Audit</h1>
      <p class="muted intro">
        Follow each step and compare it to your iPhone settings.<br>
        Select <strong>Enabled</strong> if it’s set correctly, or <strong>Needs Review</strong> if it isn’t.<br>
        At the end, you’ll receive an audit summary and risk level.
      </p>
      <button id="beginBtn" class="btn btn-primary">Begin Audit</button>
    </div>

    <!-- WIZARD -->
    <div id="wizard" class="card hidden">
      <div class="topbar">
        <div style="flex:1 1 380px; min-width:260px;">
            <div id="phaseBadge"
                 style="font-weight:600; color:#444; background:#f5f5f5; padding:6px 12px; border-radius:8px; display:inline-block;">
              Audit in Progress
            </div>
          <div class="legend">
            <span><i class="dot green"></i> Enabled</span>
            <span><i class="dot amber"></i> Needs Review</span>
            <span><i class="dot gray"></i> Skipped</span>
          </div>
          <div class="progress" style="margin-top:8px;"><i id="bar"></i></div>
          <p class="notes" id="progressNote">Step 1 of 22</p>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <button id="openDrawer" class="btn btn-secondary">View Progress</button>
        </div>
      </div>

      <!-- Step -->
      <div id="stepArea" style="margin-top:16px;">
        <h3 id="stepTitle"></h3>
        <p class="muted" id="stepPath" style="margin-top:-4px;"></p>

        <!-- Detailed explanation (formerly 'Why it matters') -->
        <p id="detail" class="detail"></p>

        <!-- Image between details and steps -->
        <img id="stepImage" class="step-img" alt="" src="" style="display:block;" onerror="this.style.visibility='hidden'"/>

        <!-- Steps (blue line) -->
        <div class="action">
          <strong>Steps</strong>
          <p id="action"></p>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="markEnabled" class="btn btn-primary">Mark as Enabled</button>
          <button id="markReviewed" class="btn btn-secondary">Needs Review</button>
          <button id="skip" class="btn btn-ghost">Skip</button>
        </div>
        <div class="foot">
          <button id="back" class="btn btn-ghost">Back</button>
        </div>
      </div>

      <!-- Confirm -->
      <div id="confirm" class="hidden" style="margin-top:16px; text-align:center;">
        <h1>Submit Audit</h1>
        <p class="muted">You’ve reached the end. Review your progress or generate your summary.</p>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px;">
          <button id="openDrawerConfirm" class="btn btn-secondary">Review Progress</button>
          <button id="generateSummary" class="btn btn-primary">Generate Summary</button>
        </div>
      </div>

      <!-- Summary -->
      <div id="summary" class="hidden" style="margin-top:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <span id="phaseComplete" class="badge minimal">Audit Complete</span>
        </div>
        <h1 style="margin-top:16px;">Audit Summary</h1>
        <p>Your iCloud Security Badge:</p>
        <div id="riskBadge" class="badge minimal">Minimal Risk</div>

        <div class="card" style="margin-top:12px;">
          <h3>Enabled Protections</h3>
          <ul id="enabledList"></ul>
        </div>
        <div class="card" style="margin-top:12px;">
          <h3>Needs Review / Skipped</h3>
          <ul id="missingList"></ul>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
          <button id="copyReport" class="btn btn-secondary">Copy Report</button>
          <button id="restart" class="btn btn-ghost">New Audit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Slide-out Drawer -->
  <div id="drawerMask" class="drawer-mask"></div>
  <aside id="drawer" class="drawer" aria-label="Progress drawer">
    <div class="drawer-head">
      <div class="drawer-title">Your Progress</div>
      <button id="closeDrawer" class="btn btn-ghost">Close</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-section">
        <div class="progress"><i id="drawerBar"></i></div>
        <p class="mini" id="drawerProgressNote" style="margin:6px 0 0;">0% complete</p>
        <p class="mini" id="drawerRisk" style="margin:4px 0 0;">Risk so far: —</p>
        <p class="mini" id="drawerCounts" style="margin:4px 0 0;">Enabled 0 • Reviewed 0 • Skipped 0</p>
      </div>
      <div id="drawerList"></div>
    </div>
  </aside>
</div>

<script>
(function(){
  /* ===== Protections (22) with severities & categories + detailed text + image ===== */
  const protections = [
    // Account Protection (includes Safety Check)
    { id:"emails", sev:"critical", cat:"Account Protection", title:"Emails & Phone Numbers",
      why:"Keeping your Apple ID contact information up to date ensures you can recover your account if you ever get locked out. Recovery messages and verification codes depend on these addresses and numbers being current. It’s a simple but essential safeguard for maintaining continuous access.",
      action:"Settings → [your name] → Sign-In & Security → Verify Emails & Phone Numbers",
      img:"images/01.png"
    },
    { id:"twofa", sev:"critical", cat:"Account Protection", title:"Two-Factor Authentication & Trusted Devices",
      why:"Two-factor authentication makes it nearly impossible for someone to sign in without your approval, even if they know your password. Only devices you trust can receive verification codes. This extra layer of identity proof keeps your account secure during logins and password resets.",
      action:"Settings → [your name] → Sign-In & Security → Two-Factor Authentication → ON + Verify Trusted Phone Numbers and Devices",
      img:"images/02.png"
    },
    { id:"rkey", sev:"critical", cat:"Account Protection", title:"Recovery Key",
      why:"A recovery key is your personal master key to regain access to your Apple ID if you lose your password or trusted devices. Keeping a printed copy stored safely ensures you’ll never lose access to your data.",
      action:"Settings → [your name] → Sign-In & Security → Recovery Key → On or Create New",
      img:"images/03.png"
    },
    { id:"adp", sev:"high", cat:"Account Protection", title:"Advanced Data Protection",
      why:"Advanced Data Protection upgrades iCloud to end-to-end encryption for most data categories, including backups, Photos, and Notes. Only your trusted devices hold the keys. Even Apple cannot access your protected data, giving you the highest level of privacy Apple offers.",
      action:"Settings → [your name] → iCloud → Advanced Data Protection → On",
      img:"images/04.png"
    },
    { id:"keys", sev:"high", cat:"Account Protection", title:"Security Keys",
      why:"Security keys replace verification codes with a physical hardware token, protecting your Apple ID from phishing and fake login pages. Without the key, no one can access your account, not even with your password. This is the most secure form of sign-in Apple supports.",
      action:"Settings → [your name] → Sign-In & Security → Two-Factor Authentication → Security Keys → Add Security Keys",
      img:"images/05.png"
    },
    { id:"webOff", sev:"high", cat:"Account Protection", title:"Access iCloud Data on the Web",
      why:"Disabling access to iCloud data through a browser minimizes the number of places your information can be reached. It prevents login attempts from unfamiliar devices or public computers. Keep this off unless you have a specific reason to use iCloud.com regularly.",
      action:"Settings → [your name] → iCloud → Access iCloud Data on the Web → Off (enable only when needed)",
      img:"images/06.png"
    },
    { id:"rcontacts", sev:"low", cat:"Account Protection", title:"Recovery Contacts",
      why:"Recovery contacts are trusted people you choose to help you regain access if you ever get locked out of your account. They can verify your identity to Apple without accessing your data. It’s a low-effort way to add a human safety net to your Apple ID.",
      action:"Settings → [your name] → Sign-In & Security → Recovery Methods → Recovery Contacts → Add Recovery Contact",
      img:"images/07.png"
    },
    { id:"safety", sev:"high", cat:"Account Protection", title:"Safety Check",
      why:"Safety Check provides an emergency reset for privacy and sharing. It instantly stops location sharing, removes shared accounts, and reviews app access. It’s a vital feature for anyone needing to reestablish personal control.",
      action:"Settings → Privacy & Security → Safety Check → Select Manage Sharing & Access (or Emergency Reset when urgent)",
      img:"images/08.png"
    },

    // Device Protection
    { id:"passcode", sev:"critical", cat:"Device Protection", title:"Require Passcode",
      why:"Your passcode is the foundation of iPhone encryption. It locks your device, encrypts stored data, and prevents anyone else from accessing your information. Without it, nearly every protection on your device is weakened or disabled.",
      action:"Settings → Face ID & Passcode → Require Passcode → Immediately",
      img:"images/09.png"
    },
    { id:"backup", sev:"critical", cat:"Device Protection", title:"iCloud Backup",
      why:"Regular iCloud backups ensure your data is safely stored and can be restored after a loss, theft, or device replacement. This protection covers photos, messages, app data, and system settings. It turns a potential disaster into a recoverable event.",
      action:"Settings → [your name] → iCloud → iCloud Backup → Back Up This iPhone → On",
      img:"images/10.png"
    },
    { id:"findmy", sev:"critical", cat:"Device Protection", title:"Find My iPhone",
      why:"Find My iPhone lets you locate, lock, or erase your device if it’s ever lost or stolen. This single feature often determines whether your data remains private or ends up exposed.",
      action:"Settings → [your name] → Find My → Find My iPhone → Turn on Find My iPhone, Find My network, and Send Last Location",
      img:"images/11.png"
    },
    { id:"erase10", sev:"critical", cat:"Device Protection", title:"Erase Data after 10 Failed Attempts",
      why:"Enabling this setting automatically erases all local data if ten incorrect passcodes are entered. It stops brute-force guessing attacks that try to unlock your phone. It’s a strong deterrent that protects your most personal information if your device is stolen.",
      action:"Settings → Face ID & Passcode → Erase Data → On",
      img:"images/12.png"
    },
    { id:"updates", sev:"critical", cat:"Device Protection", title:"Software Updates",
      why:"Keeping software up to date ensures your iPhone has the latest security patches from Apple. Most attacks target known vulnerabilities that updates quickly fix. Automatic updates close those gaps without requiring constant manual checks.",
      action:"Settings → General → Software Update → Automatic Updates → Turn on “Automatically Install”",
      img:"images/13.png"
    },
    { id:"stolen", sev:"high", cat:"Device Protection", title:"Stolen Device Protection",
      why:"Stolen Device Protection adds new safeguards when your iPhone is away from familiar locations. It requires Face ID or Touch ID, and sometimes a waiting period, before sensitive changes can be made. Even if someone knows your passcode, they can’t disable key protections.",
      action:"Settings → Face ID & Passcode → Stolen Device Protection → On",
      img:"images/14.png"
    },
    { id:"attention", sev:"high", cat:"Device Protection", title:"Require Attention for Face ID",
      why:"Requiring attention ensures your iPhone only unlocks when you are consciously looking at it. This prevents unlock attempts while you’re asleep or unaware. It’s a simple step that adds personal control to biometric security.",
      action:"Settings → Face ID & Passcode → Require Attention for Face ID → On",
      img:"images/15.png"
    },
    { id:"airdrop", sev:"high", cat:"Device Protection", title:"AirDrop",
      why:"Setting AirDrop to “Off” keeps random people nearby from sending you files or requests. This simple change reduces exposure to spam, pranks, and possible data injection attempts.",
      action:"Settings → General → AirDrop → Receiving Off or Contacts Only",
      img:"images/16.png"
    },
    { id:"bringTogether", sev:"low", cat:"Device Protection", title:"Bringing Devices Together",
      why:"Bringing Devices Together lets your iPhone and other Apple devices unlock or connect automatically when they’re close to each other. It’s convenient but should only be used around devices you own or trust. Turn it on only when you’re sharing or setting up a device.",
      action:"Settings → General → AirDrop → Bringing Devices Together → Off",
      img:"images/17.png"
    },
    { id:"wired", sev:"high", cat:"Device Protection", title:"Wired Accessories",
      why:"Limiting USB accessory access while locked prevents data connections from unknown devices. This blocks forensic tools and malicious chargers from reading data through the Lightning or USB-C port. It’s a discreet but effective layer against physical access threats.",
      action:"Settings → Privacy & Security → Wired Accessories → Ask for New Accessories",
      img:"images/18.png"
    },
    { id:"vpnmdm", sev:"high", cat:"Device Protection", title:"VPN & Device Management Review",
      why:"Reviewing VPN and device management settings ensures no hidden profiles or certificates control your network traffic or device policies. These settings are common entry points for corporate or malicious oversight. Regular review keeps your device’s configuration fully under your control.",
      action:"Settings → General → VPN & Device Management → Remove unfamiliar profiles",
      img:"images/19.png"
    },

    // Safe Browsing & Communication
    { id:"fraudWarn", sev:"low", cat:"Safe Browsing & Communication", title:"Fraudulent Website Warning",
      why:"Safari’s Fraudulent Website Warning alerts you before visiting known phishing or malicious sites. It uses real-time threat data from Apple and Google to block deceptive web pages. This prevents you from entering passwords or information into fake login portals.",
      action:"Settings → Safari → Privacy & Security → Fraudulent Website Warning → On",
      img:"images/20.png"
    },
    { id:"notSecure", sev:"low", cat:"Safe Browsing & Communication", title:"Not Secure Connection Warning",
      why:"When Safari shows a “Not Secure” label, it’s warning you that the page doesn’t use encryption. Any data entered there could be intercepted or modified. Paying attention to this alert protects your credentials and privacy during everyday browsing.",
      action:"Settings → Safari → Privacy & Security → Show Not Secure Warnings → On",
      img:"images/21.png"
    },
    { id:"ckv", sev:"low", cat:"Safe Browsing & Communication", title:"Contact Key Verification",
      why:"Contact Key Verification adds a visible trust indicator to iMessage and FaceTime. It lets you confirm that you’re communicating with the right person, not an impersonator. For high-value or sensitive conversations, it provides additional peace of mind.",
      action:"Settings → [your name] → Contact Key Verification → On",
      img:"images/22.png"
    }
  ];

  // State
  let idx = 0;
  const state = Object.fromEntries(protections.map(p => [p.id, null])); // enabled|reviewed|skipped|null

  // Elements
  const landing = document.getElementById('landing');
  const wizard = document.getElementById('wizard');
  const beginBtn = document.getElementById('beginBtn');

  const phaseBadge = document.getElementById('phaseBadge');
  const bar = document.getElementById('bar');
  const progressNote = document.getElementById('progressNote');

  const stepArea = document.getElementById('stepArea');
  const stepTitle = document.getElementById('stepTitle');
  const stepPath = document.getElementById('stepPath');
  const detailEl = document.getElementById('detail');
  const actionEl = document.getElementById('action');
  const stepImg = document.getElementById('stepImage');

  const markEnabled = document.getElementById('markEnabled');
  const markReviewed = document.getElementById('markReviewed');
  const skip = document.getElementById('skip');
  const back = document.getElementById('back');

  const confirmView = document.getElementById('confirm');
  const openDrawerConfirm = document.getElementById('openDrawerConfirm');
  const generateSummary = document.getElementById('generateSummary');

  const summary = document.getElementById('summary');
  const phaseComplete = document.getElementById('phaseComplete');
  const enabledList = document.getElementById('enabledList');
  const missingList = document.getElementById('missingList');
  const riskBadge = document.getElementById('riskBadge');
  const copyReport = document.getElementById('copyReport');
  const restart = document.getElementById('restart');

  // Drawer
  const drawer = document.getElementById('drawer');
  const drawerMask = document.getElementById('drawerMask');
  const openDrawer = document.getElementById('openDrawer');
  const closeDrawer = document.getElementById('closeDrawer');
  const drawerBar = document.getElementById('drawerBar');
  const drawerProgressNote = document.getElementById('drawerProgressNote');
  const drawerRisk = document.getElementById('drawerRisk');
  const drawerCounts = document.getElementById('drawerCounts');
  const drawerList = document.getElementById('drawerList');

  // Helpers
  function computeRiskSoFar() {
    const missingCritical = protections.filter(p => p.sev === 'critical' && state[p.id] !== 'enabled');
    const missingEnhancements = protections.filter(p =>
      ['adp','rcontacts','safety','attention','stolen','keys'].includes(p.id) && state[p.id] !== 'enabled'
    );
    const missingSurface = protections.filter(p =>
      ['webOff','airdrop','bringTogether'].includes(p.id) && state[p.id] !== 'enabled'
    );

    let level = 'Minimal Risk';

    if (missingCritical.length > 0) {
      level = 'High Risk';
    } else if (missingEnhancements.length >= 3 || missingSurface.length > 0) {
      level = 'Low Risk';
    }

    // Security Keys reduce risk by one tier
    if (state['keys'] === 'enabled' && level === 'High Risk') level = 'Low Risk';
    else if (state['keys'] === 'enabled' && level === 'Low Risk') level = 'Minimal Risk';

    return level;
  }

  function setRiskBadge(el, level){
    el.classList.remove('minimal','low','high','neutral');
    if (level === 'High Risk') el.classList.add('high');
    else if (level === 'Low Risk') el.classList.add('low');
    else if (level === 'Minimal Risk') el.classList.add('minimal');
    else el.classList.add('neutral');
    
    // Make rectangular, consistent with Audit Complete
    el.style.borderRadius = '8px';
    el.style.padding = '6px 12px';
    el.style.fontWeight = '600';
    el.style.display = 'inline-block';
    el.textContent = level;
  }

  function updateProgressUI(){
    const pct = Math.round((Math.min(idx, protections.length) / protections.length) * 100);
    bar.style.width = pct + '%';
    progressNote.textContent = `Step ${Math.min(idx+1, protections.length)} of ${protections.length}`;

    // Drawer progress
    drawerBar.style.width = pct + '%';
    drawerProgressNote.textContent = `${pct}% complete`;

    // Counts
    const enabled = Object.values(state).filter(v => v === 'enabled').length;
    const reviewed = Object.values(state).filter(v => v === 'reviewed').length;
    const skipped = Object.values(state).filter(v => v === 'skipped').length;
    drawerCounts.textContent = `Enabled ${enabled} • Needs Review ${reviewed} • Skipped ${skipped}`;

    // Risk so far
    const level = computeRiskSoFar();
    drawerRisk.textContent = `Risk so far: ${level}`;
  }

  function renderDrawerList(){
    drawerList.innerHTML = '';
    protections.forEach((p, i) => {
      const row = document.createElement('div');
      row.className = 'row';
      row.addEventListener('click', () => {
        // Jump to step i
        idx = i;
        closeProgressDrawer();
        showStep();
        window.scrollTo({top:0, behavior:'smooth'});
      });
      const dot = document.createElement('i');
      const st = state[p.id];
      dot.className = 'status ' + (st ? st : 'skipped'); // show gray if null too
      const title = document.createElement('div');
      title.className = 'row-title';
      title.textContent = `${i+1}. ${p.title}`;
      row.appendChild(dot);
      row.appendChild(title);
      drawerList.appendChild(row);
    });
  }

  function openProgressDrawer(){
    renderDrawerList();
    updateProgressUI();
    drawer.classList.add('open');
    drawerMask.classList.add('open');
  }
  function closeProgressDrawer(){
    drawer.classList.remove('open');
    drawerMask.classList.remove('open');
  }

  // Wizard rendering
  function showStep(){
    if (idx >= protections.length){
      // Done with steps → confirm screen
      stepArea.classList.add('hidden');
      confirmView.classList.remove('hidden');
      phaseBadge.textContent = 'Audit in Progress'; // remains neutral until summary
      updateProgressUI();
      return;
    }
    confirmView.classList.add('hidden');
    stepArea.classList.remove('hidden');

    const p = protections[idx];
    stepTitle.textContent = p.title;
    stepPath.textContent = `${p.cat} • ${p.sev.charAt(0).toUpperCase() + p.sev.slice(1)}`;
    detailEl.textContent  = p.why;
    actionEl.textContent  = p.action;
    console.log("Loaded image for step:", p.title, "→", p.img);

    // Reset and fade in image (prevents invisible collapse)
    stepImg.style.opacity = 0;

    // Ensure Safari doesn't keep a stale display:none
    stepImg.style.display = 'block';
    stepImg.style.visibility = 'visible';

    // Force a fresh load + repaint
    // (removing src first avoids cached layout state)
    stepImg.removeAttribute('src');

    // Hook up load/error for reliable paint
    stepImg.onload = () => {
      stepImg.style.opacity = 1; // smooth fade in when loaded
    };
    stepImg.onerror = () => {
      // Keep space reserved even if load fails
      stepImg.style.opacity = 1;
      stepImg.style.visibility = 'visible';
    };

    // Slight delay gives DOM a tick before swapping src
    setTimeout(() => {
      stepImg.src = p.img || '';
      stepImg.alt = p.title;
    }, 50);

    back.disabled = (idx === 0);
    updateProgressUI();
  }

  function showSummary(){
    // Build lists
    const enabled = protections.filter(p => state[p.id] === 'enabled');
    const missing = protections.filter(p => state[p.id] !== 'enabled');

    enabledList.innerHTML = enabled.map(p => `<li>${p.title}</li>`).join('');
    missingList.innerHTML = missing.map(p => `<li>${p.title}</li>`).join('');

    // Final risk (same logic)
    const level = computeRiskSoFar();
    setRiskBadge(riskBadge, level);

    // Top state badge
    phaseBadge.classList.add('hidden');
    phaseComplete.classList.remove('hidden');
    phaseComplete.textContent = 'Audit Complete';
    phaseComplete.classList.remove('minimal','low','high');
    phaseComplete.style.color = '#444';
    phaseComplete.style.background = '#f5f5f5';
    phaseComplete.style.border = '1px solid #E5E7EB';
    phaseComplete.style.borderRadius = '8px';
    phaseComplete.style.padding = '6px 12px';
    phaseComplete.style.fontWeight = '600';
    phaseComplete.style.display = 'inline-block';

    // Hide drawer affordances on summary
    openDrawer.classList.add('hidden');
    closeProgressDrawer();

    // Show
    stepArea.classList.add('hidden');
    confirmView.classList.add('hidden');
    summary.classList.remove('hidden');
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // Events
  beginBtn.addEventListener('click', () => {
    landing.classList.add('hidden');
    wizard.classList.remove('hidden');
    phaseBadge.textContent = 'Audit in Progress';
    showStep();
  });

  document.getElementById('markEnabled').addEventListener('click', () => {
    state[protections[idx].id] = 'enabled';
    idx++;
    showStep();
  });
  document.getElementById('markReviewed').addEventListener('click', () => {
    state[protections[idx].id] = 'reviewed';
    idx++;
    showStep();
  });
  document.getElementById('skip').addEventListener('click', () => {
    state[protections[idx].id] = 'skipped';
    idx++;
    showStep();
  });
  document.getElementById('back').addEventListener('click', () => {
    if (idx > 0){ idx--; showStep(); }
  });

  // Drawer wiring
  openDrawer.addEventListener('click', openProgressDrawer);
  openDrawerConfirm.addEventListener('click', openProgressDrawer);
  closeDrawer.addEventListener('click', closeProgressDrawer);
  drawerMask.addEventListener('click', closeProgressDrawer);

  // Generate Summary
  generateSummary.addEventListener('click', showSummary);

  // Copy report (clean text)
  copyReport.addEventListener('click', async () => {
    const today = new Date().toISOString().slice(0,10);
    const enabled = protections.filter(p => state[p.id] === 'enabled').map(p => p.title);
    const missing = protections.filter(p => state[p.id] !== 'enabled').map(p => p.title);
    const risk = riskBadge.textContent;

    const text = [
      'Clouds & Keys — iCloud Security Audit Summary',
      `Date: ${today}`,
      '',
      `Risk: ${risk}`,
      '',
      'Enabled Protections:',
      enabled.length ? '• ' + enabled.join('\n• ') : '• (None)',
      '',
      'Needs Review / Skipped:',
      missing.length ? '• ' + missing.join('\n• ') : '• (None) — All protections verified.'
    ].join('\n');

    try{
      await navigator.clipboard.writeText(text);
      copyReport.textContent = 'Copied!';
      setTimeout(()=>copyReport.textContent='Copy Report', 1200);
    }catch(e){
      alert('Copy failed. Manually copy the text below:\n\n' + text);
    }
  });

  // Restart
  restart.addEventListener('click', () => location.reload());

})();
</script>
</body>
</html>
